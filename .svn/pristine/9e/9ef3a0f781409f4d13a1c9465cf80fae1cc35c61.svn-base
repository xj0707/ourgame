<?php
namespace application\admin\controller;

use think\Db;
use think\Request;

class GameMaJiangController extends CommonController{
    //牌型测试
    public function paixing(){
        return $this->fetch();
    }
    //ajax验证
    public function  doAction(Request $request){
        if($request->isAjax()){
            $username=input('username');
            $merchantId=input('merchantId');
            $res=Db::name('gameuser')->where('szUserName',$username)->where('merchantId',$merchantId)->find();
            if($res){
                $uid=$res['un32UserID'];
                return json(['code'=>1,'message'=>'操作成功','uid'=>$uid]);
            }else{
                return json(['code'=>-2,'message'=>'没有找到该玩家']);
            }
        }else{
            return json(['code'=>-1,'message'=>'非法请求！']);
        }
    }
    //牌型
    public function dopaixing(Request $request){
        if($request->isAjax()){
            $uid=input('uid');
            $paixin=input('paixin');
            $strlen=strlen($paixin);
            //连接服务器
            $host='192.168.3.95';
            $port='20003';
            $protectId=config('majiang');
            $socket=socket_create(AF_INET,SOCK_STREAM,SOL_TCP);
            if($socket==false){
                return json(['code'=>-1,'message'=>'与服务器连接失败1！！']);
            }
            if(@$conn=socket_connect($socket,$host,$port)==false){
                return json(['code'=>-1,'message'=>'与服务器连接失败2！！']);
            }
            $user_id=session('user_id');
            $info=Db::name('admin')->where('id',$user_id)->find();
            //$length=strlen($info['username']);
            $sendlen=4+4+4+4+32+4+4+$strlen;
            // 向socket服务器发送消息
            if(!@socket_write($socket, pack("IIIIa32IIa$strlen",$sendlen,$protectId,$user_id,32,$info['password'],$uid,$strlen,$paixin))){
                return json(['code'=>-1,'message'=>'与服务器连接失败3！！']);
            }else{
                return json(['code'=>1,'message'=>'操作成功！！']);
            }

        }else{
            return json(['code'=>-1,'message'=>'非法请求！']);
        }
    }
}